name: Process Telegram

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6:00 UTC
  workflow_dispatch:
    inputs:
      since_hours:
        description: 'Hours to look back'
        required: false
        default: '24'
      skip_publish:
        description: 'Skip publish step'
        required: false
        type: boolean
        default: false

concurrency:
  group: telegram-pipeline
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write  # Required for Claude Code Action OIDC

jobs:
  process:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
      TELEGRAM_PUBLISH_CHANNEL: ${{ vars.TELEGRAM_PUBLISH_CHANNEL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Read channels
        run: |
          cd agent/integrations/telegram
          pip install -r requirements.txt
          python telegram.py --read --since ${{ github.event.inputs.since_hours || '24' }}

      # --- LLM Pipeline ---
      - name: Generate digest
        uses: ./.github/actions/llm-pipeline
        with:
          prompt_file: .github/prompts/curate-digest.md
          data_file: /tmp/telegram_messages.json
          output_file: /tmp/llm_response.txt
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          provider: ${{ vars.LLM_PROVIDER || 'claude' }}
          model: ${{ vars.LLM_MODEL || 'claude-sonnet-4-6' }}
          max_tokens: ${{ vars.LLM_MAX_TOKENS || '12,288' }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          google_api_key: ${{ secrets.GOOGLE_API_KEY }}
          google_application_credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
          vertex_project: ${{ vars.VERTEX_PROJECT }}
          vertex_region: ${{ vars.VERTEX_REGION }}

      # --- Publish ---
      - name: Publish digest
        if: ${{ github.event.inputs.skip_publish != 'true' }}
        working-directory: agent/integrations/telegram
        run: python telegram.py --post
